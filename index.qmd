---
title: "Regulatory Repositories"
author:
  - name: "<span>Coline Zeballos</span> <span style='font-style: italic; margin-left: 0.5em;'><a href='http://www.roche.com'>Roche</a></span>"
  - name: "<span>Yann Féat</span> <span style='font-style: italic; margin-left: 0.5em;'><a href='http://mainanalytics.de'>mainanalytics</a></span>"
reference-location: margin
---



## A Universal Conundrum {.scrollable}

_There are `n` packages for `x`, which one is the best?[^1]_

![](resources/choosing_a_package.png)

[^1]: [https://stackoverflow.com/questions/28650957]()

::: {.notes}
Coline

- A typical "first analysis" question
- Immediately need to make a decision about which packages to use: base R, `dplyr` or `data.table`
- Which one is right for me?
:::



## A Universal Conundrum

### By choosing packages, we're choosing our [^2]

* Feature set
* Dependency footprint
* Integration with other packages
* Preferred lifecycle management of our tools
* Community that we can lean on for help

[^2]: [It depends: A dialog about dependencies, Jim Hester (2019)](https://www.jimhester.com/talk/2019-rsc-deps/)



## A Universal Conundrum

### Regulated Industries: Justification as a Requirement

![](resources/white_paper_guidelines.png)




## Goals

- Provide a community-maintained catalog of package quality indicators ("risk metrics")
- Serve quality indicators in a standard format
- Thoroughly document the system used to perform quality assessment
- Demonstrate how regulatory-ready risk assessments can be provided using public quality indicators
- Serve subsets of packages that conform to a specified risk tolerance
- Improve transparency of industry R package adoption, endorsement and regulator interaction

::: {.notes}
Coline
:::

## An evolving R ecosystem

- (NOTE: show interaction between CRAN, RVH Reg R Repo (us), RC Submissions WG, RC Repositories WG, pharmaverse, other?)

# Stage 0: overview

![](resources/wizare_of_oz_demo.png)

# Interacting with the repo

## Packages risk filters

::: columns
::: {.column width="50%"}
- Helper package for system administrators
- Restricts packages available for installation to those fitting in a policy
- Uses packages metadata in the repo
- May be used together with manual checks (e.g. read a statistical review)
:::
::: {.column width="50%"}
- Example of automated filter for safety-critical activities:
  - Acceptance Criteria 1: “Code Coverage > 95% ”
  - Acceptance Criteria 2: “Package documentation available”
:::
:::

::: {.notes}
Yann
:::

## Usage

```{r}
#| echo: false
summarize_available_packages <- function(ap) {
  out <- cbind(ap, data.frame("..." = "..."))
  out <- out[c(1:4, nrow(ap)), c("Package", "...")]
  out[4,] <- c("...", "...")
  rownames(out) <- c("1", "2", "3", "...", nrow(ap))
  out
}
```

::: columns
::: {.column width="40%"}
### Unfiltered
```{r}
#| echo: true
#| eval: false
available.packages()
```
```{r}
#| echo: false
pkgs_nofltr_path <- file.path(here::here(), "resources", "pkgs_nofltr.rds")
pkgs_nofltr <- readRDS(file = pkgs_nofltr_path)
summarize_available_packages(pkgs_nofltr)
```
:::

::: {.column width="60%"}
### Filtered
```{r}
#| echo: true
#| eval: false
fltr <- risk_filter(covr_coverage > 0.95 && has_vignettes)
options(available_packages_filters = fltr)
available.packages()
```
```{r}
#| echo: false
pkgs_fltr_path <- file.path(here::here(), "resources", "pkgs_fltr.rds")
pkgs_fltr <- readRDS(file = pkgs_fltr_path)
summarize_available_packages(pkgs_fltr)
```
:::
:::

::: {.notes}
Yann
:::

# Repository ‘back-end’

## Repository forked from `r-hub/repos`

Mandatory package metadata for a package repository
```{.yaml}
Package: bslib
Version: 0.6.1
Depends: R (>= 2.10), R (>= 4.4), R (< 4.4.99)
License: MIT + file LICENSE
Built: R 4.4.0; ; 2023-11-29 16:39:06 UTC; unix
RVersion: 4.4
Platform: x86_64-pc-linux-gnu-ubuntu-22.04
Imports: base64enc, cachem, grDevices, htmltools (>= 0.5.7), jquerylib (>= 0.1.3),
         jsonlite, lifecycle, memoise (>= 2.0.1), mime, rlang, sass (>= 0.4.0)
...
```
Added fields for risk-based assessment
```{.yaml code-line-numbers="4-5"}
riskmetric_run_date: 2023-06-21
riskmetric_version: 0.2.1
pkg_score: 0.291481580696657
covr_coverage: 0.852820470987098
has_vignettes: 1
has_news: 1
reverse_dependencies: 0.900122893005357
dependencies: 0.0474258731775666
remote_checks: 0.846153846153846
has_maintainer: 1
...
```

::: {.notes}
Yann
:::

## Packages cohort validation

* Risk metrics calculated on packages with new versions and on their reverse dependencies
* Uses the GitHub API to fetch new release assets

```{r}
#| echo: false
df_pkg_metrics <- readRDS(file = file.path(
  here::here(), "resources", "df_pkg_metrics.rds"))
df_pkg_metrics$pkg_score <- round(df_pkg_metrics$pkg_score, 4)
df_pkg_metrics[1:3,
  c("package", "version", "ver_old", "pkg_score", "has_news")]
```

::: {.notes}
Yann
:::

# Our roadmap

## Reference container image(s)

- Should mimic environments of companies and health authority reviewers
- Integrates with most modern analytic workbench tools and an evaluation pipeline
- To be used by the Regulatory R Repository for packages cohort validation

## What's next

* (NOTE: STAGE 1: Pipeline Integration)

# Closing

## Join us

* (NOTE: link to GH join us issue, add R Consortium info)

## Thank you

* (NOTE: list of Core team members)
